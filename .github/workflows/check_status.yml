name: Check Server Status

on:
  schedule:
    - cron: '*/15 * * * *' # Runs every 15 minutes
  workflow_dispatch:       # Allows you to click "Run workflow" manually

permissions:
  contents: write          # Needed to push the badge update to your README

jobs:
  ping-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check URL and Update Badge
        run: |
          # --- Configuration ---
          TARGET_URL="http://scann.ddns.net:8000/badge"
          
          # Just the image URLs (Clean strings, no markdown syntax here)
          IMG_ONLINE="https://img.shields.io/badge/STATUS-online-green"
          IMG_OFFLINE="https://img.shields.io/badge/STATUS-offline-red?link=mailto%3Aminh.mangbachkhoahochiminh%40hcmut.edu.vn"
          
          # --- Logic ---
          echo "Pinging $TARGET_URL..."
          
          # FIX 1: We added '|| echo "000"'
          # If curl fails (network error/timeout), it won't crash the script.
          # It will just print "000", which triggers the OFFLINE logic below.
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$TARGET_URL" || echo "000")
          
          echo "Response Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Server is ONLINE."
            BADGE="![Status]($IMG_ONLINE)"
          else
            echo "Server is OFFLINE (or unreachable)."
            BADGE="![Status]($IMG_OFFLINE)"
          fi

          # FIX 2: Safe Sed Command
          # Only replaces text strictly between the start/end comments
          sed -i "s|!\[Status\](https://img.shields.io/.*)|$BADGE|g" README.md

      - name: Commit and Push changes
        run: |
          git config --global user.name "Status Bot"
          git config --global user.email "actions@github.com"
          
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "Update status badge"
            git push
          else
            echo "No change detected."
          fi
